<!DOCTYPE html>
<html lang="ru">
<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#4CAF50">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="–¥–µ–Ω—å–ì–∞">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="manifest" href="manifest.json">
<title>–¥–µ–Ω—å–ì–∞</title>
<link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
<style>
/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–æ–ø–∫–∏ */
.card-stack-btn {
    position: fixed;
    bottom: 40px; /* –ü–æ–¥–Ω—è—Ç–æ —Å 20px –Ω–∞ 40px */
    right: 20px;
    width: 100px;
    cursor: pointer;
    perspective: 800px;
    z-index: 999;
    display: none;
}
.card-stack-btn.expanded {
    z-index: 1001;
}
/* –ö–∞—Ä—Ç–∞ */
.card {
    position: absolute;
    width: 80px;
    height: 50px;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    font-weight: bold;
    color: white;
    font-size: 18px;
    transform-origin: top center;
    transition: transform 0.4s cubic-bezier(0.25, 1.5, 0.5, 1), box-shadow 0.4s;
    user-select: none;
}
/* –¶–≤–µ—Ç–∞ –∏ –ø–æ–¥–ø–∏—Å–∏ –∫–∞—Ä—Ç */
.card[data-bank="–°–±–µ—Ä"] { background-color: #0f9d58; }
.card[data-bank="–Ø–Ω–¥–µ–∫—Å"] { background-color: #ff6eb4; }
.card[data-bank="–¢–∏–Ω—å–∫–æ—Ñ—Ñ"] { background-color: #FFD700; color:#000; }
.card[data-bank="–ê–ª—å—Ñ–∞"] { background-color: #FF0000; }
.card[data-bank="–í–¢–ë"] { background-color: #1E90FF; }
.card[data-bank="–•–∞–ª–≤–∞"] { background-color: #A9A9A9; color:#000; }
.card[data-bank="–£—Ä–∞–ª—Å–∏–±"] { background-color: #800080; }
.card[data-bank="–î—Ä—É–≥–∏–µ"] { background-color: #000000; }
/* –ü–æ–ª–æ–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç –≤ —Å–ª–æ–∂–µ–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ */
.card-stack-btn:not(.expanded) .card:nth-child(1) { transform: translate(0, 0) rotate(0deg); z-index: 8; }
.card-stack-btn:not(.expanded) .card:nth-child(2) { transform: translate(0, -5px) rotate(0deg); z-index: 7; }
.card-stack-btn:not(.expanded) .card:nth-child(3) { transform: translate(0, -10px) rotate(0deg); z-index: 6; }
.card-stack-btn:not(.expanded) .card:nth-child(4) { transform: translate(0, -15px) rotate(0deg); z-index: 5; }
.card-stack-btn:not(.expanded) .card:nth-child(5) { transform: translate(0, -20px) rotate(0deg); z-index: 4; }
.card-stack-btn:not(.expanded) .card:nth-child(6) { transform: translate(0, -25px) rotate(0deg); z-index: 3; }
.card-stack-btn:not(.expanded) .card:nth-child(7) { transform: translate(0, -30px) rotate(0deg); z-index: 2; }
.card-stack-btn:not(.expanded) .card:nth-child(8) { transform: translate(0, -35px) rotate(0deg); z-index: 1; }
/* –ü–æ–ª–æ–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏ */
.card-stack-btn.expanded .card {
    transition: transform 0.4s cubic-bezier(0.25, 1.5, 0.5, 1), box-shadow 0.4s;
}
.card-stack-btn.expanded .card:nth-child(1) { transform: translate(0, 0px) rotate(0deg) scale(1.05); z-index: 1; }
.card-stack-btn.expanded .card:nth-child(2) { transform: translate(0, -70px) rotate(-5deg) scale(1.05); z-index: 2; }
.card-stack-btn.expanded .card:nth-child(3) { transform: translate(0, -140px) rotate(3deg) scale(1.05); z-index: 3; }
.card-stack-btn.expanded .card:nth-child(4) { transform: translate(0, -210px) rotate(-3deg) scale(1.05); z-index: 4; }
.card-stack-btn.expanded .card:nth-child(5) { transform: translate(0, -280px) rotate(2deg) scale(1.05); z-index: 5; }
.card-stack-btn.expanded .card:nth-child(6) { transform: translate(0, -350px) rotate(-2deg) scale(1.05); z-index: 6; }
.card-stack-btn.expanded .card:nth-child(7) { transform: translate(0, -420px) rotate(4deg) scale(1.05); z-index: 7; }
.card-stack-btn.expanded .card:nth-child(8) { transform: translate(0, -490px) rotate(-4deg) scale(1.05); z-index: 8; }
.card .bank-buttons {
    position: absolute;
    left: 110%;
    top: 60%;
    transform: translateY(-50%);
    display: flex;
    gap: 5px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}
.card-stack-btn.expanded .card .bank-buttons {
    opacity: 0;
    pointer-events: auto;
}
.bank-buttons button {
    background: none;
    border: none;
    color: transparent;
    opacity: 0;
    width: 40px;
    height: 40px;
    cursor: pointer;
    transition: opacity 0.3s, color 0.3s;
}
.card-stack-btn.expanded .card .bank-buttons button {
    opacity: 0;
    color: transparent;
}
/* –û–≤–µ—Ä–ª–µ–π —Å —É—Å–∏–ª–µ–Ω–Ω—ã–º –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ–º */
#overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0,0,0,0.85);
    display: none;
    z-index: 1000;
}
html, body {
    overflow-x: hidden;
    touch-action: pan-y;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background-color: #f2f2f2;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}
header {
    background: linear-gradient(145deg, #4CAF50, #2E7D32);
    color: white;
    font-weight: bold;
    text-align: left;
    font-size: 32px;
    padding: 30px 40px;
    margin: 15px;
    border-radius: 16px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.25), inset 0 2px 6px rgba(255,255,255,0.3);
    position: relative;
    overflow: hidden;
    font-family: 'MedievalSharp', cursive;
}
.shine-container {
    position: absolute;
    top: 28px;
    left: 11%;
    width: 78%;
    height: 163px;
    overflow: hidden;
    pointer-events: none;
}
.shine-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: -30%;
    width: 40%;
    height: 100%;
    background: linear-gradient(120deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.4) 30%, rgba(255,255,255,0.1) 60%);
    transform: skewX(-25deg);
    animation: shine 10s infinite;
}
@keyframes shine {
    0% { left: -120%; opacity: 0; }
    5% { opacity: 1; }
    70% { left: 100%; opacity: 0.1; }
    100% { left: 100%; opacity: 0; }
}
header::after {
    content: '';
    position: absolute;
    top: 50px;
    right: 50px;
    width: 40px;
    height: 28px;
    background: linear-gradient(135deg, #d4af37, #f5e29f);
    border-radius: 4px;
    box-shadow: inset 0 0 3px rgba(0,0,0,0.3);
}
.header-box {
    display: inline-block;
    background: transparent;
    color: #fff;
    font-size: 36px;
    letter-spacing: 1px;
    text-shadow: 0 0 8px rgba(0,0,0,0.4);
}
nav {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
}
nav button {
    padding: 12px 22px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 10px;
    border: 2px solid #0b5ea8;
    background: white;
    color: #4CAF50;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    z-index: 1;
}
nav button:hover {
    background: linear-gradient(135deg, #A8E6A2, #45A049);
    color: white;
}
button:hover {
    background-color: #0b7dda;
}
@keyframes spring {
    0% { transform: scale(1); }
    10% { transform: scale(0.7); }
    20% { transform: scale(1.3); }
    30% { transform: scale(0.8); }
    40% { transform: scale(1.2); }
    50% { transform: scale(0.9); }
    60% { transform: scale(1.1); }
    70% { transform: scale(0.95); }
    80% { transform: scale(1.05); }
    90% { transform: scale(0.99); }
    100% { transform: scale(1); }
}
.springing {
    animation: spring 0.95s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}
main {
    padding: 20px;
    text-align: center;
}
section {
    display: none;
}
#categoriesList {
    display: block;
    margin-top: 15px;
}
#categoriesList button {
    display: block;
    width: 65%;
    margin: 10px 0;
    padding: 16px 20px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 10px;
    position: relative;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    background: linear-gradient(135deg, #5A7DE1, #A0D4FA);
    color: white;
    border: 2px solid #0b5ea8;
    text-align: left;
    margin-left: 20px;
}
#sparkCanvas {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 1000;
}
.action-modal {
    position: fixed;
    background: rgba(65, 105, 225, 1);
    border-radius: 20px;
    box-shadow: 0 7px 19px rgba(0,0,0,0.25);
    padding: 25px;
    display: flex;
    gap: 10px;
    flex-direction: column;
    animation: fadeIn 0.1s ease-out;
    z-index: 9999;
}
.action-modal button {
    background: linear-gradient(135deg, rgba(244,67,54,1), rgba(255,153,153,1));
    color: white;
    font-weight: bold;
    padding: 20px;
    border-radius: 38px;
    transition: background 0.2s;
}
.action-modal button.rename {
    background: #2196F3;
}
.action-modal button:hover {
    opacity: 0.85;
}
@keyframes fadeIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
.rename-container {
    margin-top: 5px;
    display: flex;
    justify-content: center;
}
.rename-container input {
    padding: 5px;
    margin-right: 5px;
    width: 60%;
    max-width: 200px;
}
.rename-container button {
    padding: 5px 10px;
}
.placeholder {
    border: 2px dashed #2196F3;
    margin-bottom: 10px;
    height: 40px;
}
.dragging {
    opacity: 0.7;
    position: absolute;
    z-index: 1000;
    pointer-events: none;
}
#statsCategories {
    margin-top: 10px;
    text-align: left;
    max-width: 600px;
    margin-inline: auto;
}
.stat-item {
    background: #ffffff;
    border: 2px solid #4CAF50;
    border-radius: 10px;
    padding: 10px 14px;
    margin-bottom: 8px;
    font-size: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#settingsSubmenu {
    display: none;
    margin-top: 15px;
    padding: 10px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}
#settingsCategories button {
    display: block;
    width: 100%;
    margin-bottom: 8px;
    padding: 8px 12px;
    background: #2196F3;
    color: #fff;
    border: none;
    border-radius: 6px;
    text-align: left;
    cursor: pointer;
    transition: background 0.3s;
}
#settingsCategories button:hover {
    background: #0b7dda;
}
#settings button {
    display: block;
    width: 100%;
    margin-bottom: 10px;
    padding: 10px 15px;
    background: linear-gradient(135deg, #5A7DE1, #A0D4FA);
    color: #fff;
    border: none;
    border-radius: 6px;
    text-align: left;
    cursor: pointer;
    transition: background 0.3s;
}
#settings button:hover {
    background: #0b7dda;
}
.totals-box {
    background: #4CAF50;
    border-radius: 12px;
    padding: 15px;
    color: white;
    font-weight: bold;
    text-align: center;
    margin-top: 15px;
    font-size: 18px;
}
#totalsContainer {
    background: #4CAF50;
    border-radius: 12px;
    padding: 20px;
    color: white;
    font-weight: bold;
    text-align: center;
    margin-top: 20px;
}
#totalsContainer h3 {
    margin-top: 0;
    font-size: 20px;
}
#totalsContainer p {
    margin: 8px 0;
    font-size: 18px;
}
.app-container {
    margin-left: auto;
    margin-right: auto;
    padding-left: 15px;
    padding-right: 15px;
    max-width: 1200px;
    border-left: 5px solid #0b5ea8;
    border-right: 5px solid #0b5ea8;
    box-sizing: border-box;
    background-color: #f2f2f2;
}
@media (max-width: 600px) {
    .app-container {
        padding-left: 8px;
        padding-right: 8px;
        border-left: 2px solid #0b5ea8;
        border-right: 2px solid #0b5ea8;
    }
}
#clock {
    opacity: 0;
    background: transparent !important;
    box-shadow: none !important;
    color: transparent !important;
}
.switch {
    position: relative;
    display: inline-block;
    width: 46px;
    height: 26px;
    vertical-align: middle;
}
.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .3s;
    border-radius: 34px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
}
input:checked + .slider {
    background-color: #4CAF50;
}
input:checked + .slider:before {
    transform: translateX(20px);
}
.limit-badge {
    display: inline-block;
    padding: 4px 10px;
    margin-left: 8px;
    background: #f0f0f0;
    border-radius: 12px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.1);
    font-size: 14px;
    font-weight: bold;
    color: #4CAF50;
    min-width: 50px;
    text-align: center;
    transition: background 0.3s, transform 0.2s;
    cursor: pointer;
}
.limit-badge:hover {
    background: #e0ffe0;
    transform: scale(1.05);
}
.limit-badge.active {
    background: #4CAF50;
    color: white;
}
.limit-badge:active {
    animation: pressAnimation 0.2s ease-out;
}
@keyframes pressAnimation {
    0% { transform: scale(1); background: #d0d0d0; }
    50% { transform: scale(0.9); background: #b0b0b0; }
    100% { transform: scale(1); background: #f0f0f0; }
}
.limit-badge.active:active {
    animation: pressAnimationActive 0.2s ease-out;
}
@keyframes pressAnimationActive {
    0% { transform: scale(1); background: #4CAF50; }
    50% { transform: scale(0.9); background: #3d8b40; }
    100% { transform: scale(1); background: #4CAF50; }
}
.settings-row {
    display: flex;
    align-items: center;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 8px 12px;
    margin-bottom: 8px;
}
.settings-row .name {
    font-weight: bold;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
}
.limit-badge {
    margin: 0 10px;
    min-width: 60px;
    text-align: center;
}
.settings-row .switch {
    flex-shrink: 0;
}
#background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: white;
    z-index: -1;
}
body,
.app-container,
header,
nav,
main,
section,
#statsCategories,
#settingsSubmenu,
#adminSubmenu {
    background: transparent !important;
    box-shadow: none !important;
}
button {
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255,255,255,0.3);
}
.action-modal {
    background: rgba(255,255,255,0.15) !important;
    backdrop-filter: blur(10px);
    box-shadow: none !important;
}
#background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: white;
    z-index: -1;
}
#header-layer header {
    background: linear-gradient(135deg, #E6FFE6, #45A049);
    color: #0b5ea8;
    font-weight: bold;
    text-align: center;
    font-size: 42px;
    padding: 25px;
    border-radius: 0 0 12px 12px;
    font-family: 'MedievalSharp', cursive;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}
nav {
    margin-top: 50px;
}
#header-layer {
    position: relative;
    width: 100%;
    z-index: -2;
    overflow: visible;
}
.header-box {
    display: inline-block;
    background: #4CAF50;
    color: white;
    padding: 60px 93px;
    border-radius: 12px;
    border: 2px solid rgba(255,255,255,0.8);
    box-shadow: 0 0 10px #4CAF50, 0 0 20px rgba(11,94,168,0.6);
    font-family: 'MedievalSharp', cursive;
    font-size: 34px;
}
#scrollLayer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 50px;
    pointer-events: none;
    z-index: 1000000;
}
#scrollBar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 0;
    background: linear-gradient(180deg, #4CAF50, #81C784);
    z-index: -1;
    pointer-events: none;
    transition: height 0.1s ease-out;
}
/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ */
.history-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    z-index: 1001;
    max-width: 90vw;
    max-height: 80vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    touch-action: auto;
}
.history-modal table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
    table-layout: fixed;
    display: block;
    overflow-x: auto;
    overflow-y: auto;
    max-height: 60vh;
    white-space: nowrap;
    touch-action: auto;
    -webkit-overflow-scrolling: touch;
}
.history-modal th,
.history-modal td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    box-sizing: border-box;
    max-width: 100px;
}
.history-modal th {
    background-color: #f2f2f2;
    font-weight: bold;
}
.history-modal button {
    padding: 10px 20px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
}
.history-modal button:hover {
    background: #45a049;
}
.history-filter {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.history-filter select {
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ddd;
    background: #f9f9f9;
    font-size: 14px;
}
.close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 0;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
}
.close-btn:hover {
    color: #f44336;
}
.close-btn::before,
.close-btn::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 2px;
    background: currentColor;
}
.close-btn::before {
    transform: rotate(45deg);
}
.close-btn::after {
    transform: rotate(-45deg);
}
#hawkBlocker {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 9998;
    pointer-events: auto;
}
#hawkBlocker:not(.hawk-mode) {
    display: none;
}
#categoriesList button {
    pointer-events: auto;
}
#exitHawkBtn {
    pointer-events: auto;
}
.version-text {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 12px;
    color: white;
    opacity: 0.7;
    font-family: Arial, sans-serif;
    z-index: 10;
}
/* –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ */
.confirm-delete-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.confirm-delete-modal .modal-content {
    background: linear-gradient(145deg, #ef5350, #d32f2f);
    color: white;
    width: 90%;
    max-width: 340px;
    padding: 28px 24px;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    text-align: center;
}

.confirm-delete-modal h3 {
    margin: 0 0 14px 0;
    font-size: 22px;
}

.confirm-delete-modal .category-name {
    font-size: 19px;
    font-weight: bold;
    margin: 12px 0 22px 0;
    padding: 10px;
    background: rgba(255,255,255,0.18);
    border-radius: 12px;
}

.confirm-delete-modal .warning-text {
    font-size: 14px;
    opacity: 0.9;
    margin: 0 0 28px 0;
    line-height: 1.4;
}

.confirm-delete-modal .buttons {
    display: flex;
    gap: 16px;
    justify-content: center;
}

.confirm-delete-modal button {
    padding: 14px 32px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.18s;
}

.confirm-delete-modal .btn-delete {
    background: #b71c1c;
    color: white;
}

.confirm-delete-modal .btn-delete:hover {
    background: #9a0007;
    transform: translateY(-1px);
}

.confirm-delete-modal .btn-cancel {
    background: rgba(255,255,255,0.25);
    color: white;
    border: 1px solid rgba(255,255,255,0.5);
}

.confirm-delete-modal .btn-cancel:hover {
    background: rgba(255,255,255,0.4);
}
</style>
</head>
<body>
<div id="overlay"></div>
<div class="card-stack-btn" id="cardStack">
    <div class="card" data-bank="–°–±–µ—Ä"><span>–°–±–µ—Ä</span><div class="bank-buttons"><button data-bank="–°–±–µ—Ä">–°–±–µ—Ä</button></div></div>
    <div class="card" data-bank="–Ø–Ω–¥–µ–∫—Å"><span>–Ø</span><div class="bank-buttons"><button data-bank="–Ø–Ω–¥–µ–∫—Å">–Ø–Ω–¥–µ–∫—Å</button></div></div>
    <div class="card" data-bank="–¢–∏–Ω—å–∫–æ—Ñ—Ñ"><span>–¢</span><div class="bank-buttons"><button data-bank="–¢–∏–Ω—å–∫–æ—Ñ—Ñ">–¢–∏–Ω—å–∫–æ—Ñ—Ñ</button></div></div>
    <div class="card" data-bank="–ê–ª—å—Ñ–∞"><span>–ê</span><div class="bank-buttons"><button data-bank="–ê–ª—å—Ñ–∞">–ê–ª—å—Ñ–∞</button></div></div>
    <div class="card" data-bank="–í–¢–ë"><span>–í–¢–ë</span><div class="bank-buttons"><button data-bank="–í–¢–ë">–í–¢–ë</button></div></div>
    <div class="card" data-bank="–•–∞–ª–≤–∞"><span>–•–∞–ª–≤–∞</span><div class="bank-buttons"><button data-bank="–•–∞–ª–≤–∞">–•–∞–ª–≤–∞</button></div></div>
    <div class="card" data-bank="–£—Ä–∞–ª—Å–∏–±"><span>–£—Ä–∞–ª</span><div class="bank-buttons"><button data-bank="–£—Ä–∞–ª—Å–∏–±">–£—Ä–∞–ª—Å–∏–±</button></div></div>
    <div class="card" data-bank="–î—Ä—É–≥–∏–µ"><span>–î—Ä—É–≥–∏–µ</span><div class="bank-buttons"><button data-bank="–î—Ä—É–≥–∏–µ">–î—Ä—É–≥–∏–µ</button></div></div>
</div>
<div id="header-layer">
    <header>
        <span class="header-box">–¥—¢–Ω—å–≥–∞</span>
        <span id="appVersion" class="version-text"></span>
    </header>
    <div class="shine-container"></div>
</div>
<div id="scrollBar"></div>
<div class="app-container">
    <nav>
        <button onclick="spring(this); showSection('expenses')">–†–∞—Å—Ö–æ–¥—ã</button>
        <button onclick="spring(this); showSection('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button onclick="spring(this); showSection('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </nav>
    <main>
        <section id="expenses">
            <h2>–†–∞—Å—Ö–æ–¥—ã</h2>
            <p></p>
            <button onclick="addCategory(this)">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
            <div id="newCategoryContainer"></div>
            <div id="categoriesList"></div>
        </section>
        <section id="stats">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <p></p>
            <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
            <div id="statsCategories"></div>
            <h3>–î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
            <canvas id="statsChart" width="400" height="400"></canvas>
            <h3>–ò—Ç–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
            <div id="totalExpenses" class="totals-box"></div>
            <h3>–ò—Ç–æ–≥–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã</h3>
            <div id="totalLimits" class="totals-box"></div>
            <button onclick="spring(this); showHistory()">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤</button>
        </section>
        <section id="settings">
    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
    <p></p>
    <button onclick="toggleSubmenu()">–ª–∏–º–∏—Ç—ã</button>
    <div id="settingsSubmenu" style="display: none;">
        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
        <div id="settingsCategories"></div>
    </div>
    <button onclick="toggleAdminSubmenu()">—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</button>
    <div id="adminSubmenu" style="display: none; margin-top: 15px; padding: 10px; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
        <button onclick="if(confirm('–¢—ã —É–≤–µ—Ä–µ, —á—Ç–æ —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å —Å –ª–∏–º–∏—Ç–∞–º–∏ —Ç–æ, —á—Ç–æ —Ö–æ—á–µ—à—å?')) clearLimits();">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ª–∏–º–∏—Ç—ã</button>
        <button onclick="if(confirm('–¢—ã —É–≤–µ—Ä–µ–Ω, —á—Ç–æ —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏ —Ç–æ, —á—Ç–æ —Ö–æ—á–µ—à—å?')) clearExpenses();">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã</button>
    </div>
    <button onclick="forceUpdate()">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
</section>
    </main>
    <canvas id="sparkCanvas"></canvas>
    <script>
        let cards = [];
        const stack = document.getElementById('cardStack');
        const overlay = document.getElementById('overlay');
        const cardStack = document.getElementById('cardStack');
        let chartInstance = null;

        function initCards() {
            if (!stack || !overlay) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç—ã stack –∏–ª–∏ overlay –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }
            const getCards = () => Array.from(stack.querySelectorAll('.card'));
            cards = getCards();

            function moveCardToTop(bankName) {
                if (cards.length === 0) return;
                const card = cards.find(c => c.dataset.bank === bankName);
                if (!card) return;
                stack.prepend(card);
                cards = [card, ...cards.filter(c => c !== card)];
                localStorage.setItem('selectedBank', bankName);
                if (!stack.classList.contains('expanded')) {
                    updateCardStyles();
                }
                initCardListeners();
            }

            function updateCardStyles() {
                cards.forEach((card, index) => {
                    card.style.zIndex = cards.length - index;
                    card.style.transform = `translate(0, ${-index * 5}px) rotate(0deg)`;
                });
            }

            function toggleStack() {
                stack.classList.toggle('expanded');
                overlay.style.display = stack.classList.contains('expanded') ? 'block' : 'none';
                if (!stack.classList.contains('expanded')) {
                    updateCardStyles();
                } else {
                    cards.forEach(card => {
                        card.style.transform = '';
                        card.style.zIndex = '';
                    });
                }
            }

            stack.addEventListener('click', e => {
                if (e.target.closest('button')) return;
                toggleStack();
            });

            overlay.addEventListener('click', () => {
                stack.classList.remove('expanded');
                overlay.style.display = 'none';
                updateCardStyles();
            });

            stack.querySelectorAll('.bank-buttons button').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const bankName = btn.dataset.bank || btn.textContent.trim();
                    moveCardToTop(bankName);
                    stack.classList.remove('expanded');
                    overlay.style.display = 'none';
                    updateCardStyles();
                });
            });

            function initCardListeners() {
                getCards().forEach(card => {
                    card.removeEventListener('click', handleCardClick);
                    card.addEventListener('click', handleCardClick);
                });
            }

            function handleCardClick(e) {
                if (!stack.classList.contains('expanded')) return;
                e.stopPropagation();
                const bankName = this.dataset.bank;
                moveCardToTop(bankName);
                stack.classList.remove('expanded');
                overlay.style.display = 'none';
                updateCardStyles();
            }

            initCardListeners();
            updateCardStyles();
            const savedBank = localStorage.getItem('selectedBank');
            if (savedBank) {
                setTimeout(() => moveCardToTop(savedBank), 100);
            }
        }

        function showSection(id) {
            const sections = document.querySelectorAll('main section');
            sections.forEach(sec => sec.style.display = 'none');
            const targetSection = document.getElementById(id);
            if (targetSection) {
                targetSection.style.display = 'block';
            } else {
                console.warn(`–°–µ–∫—Ü–∏—è —Å id "${id}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
            }
            if (id === 'expenses') {
                cardStack.style.display = 'block';
            } else {
                cardStack.style.display = 'none';
                if (cardStack.classList.contains('expanded')) {
                    cardStack.classList.remove('expanded');
                    overlay.style.display = 'none';
                    updateCardStyles();
                }
            }
            if (id === 'stats') {
                renderCategories();
            }
        }

        function spring(button) {
            if (!button) return;
            button.classList.remove('springing');
            void button.offsetWidth;
            button.classList.add('springing');
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        function saveCategory(name) {
    let categories = JSON.parse(localStorage.getItem('categories')) || [];
    categories.push({name: name, amount: 0, limit: 0, lastUpdate: null, limitEnabled: false});
    localStorage.setItem('categories', JSON.stringify(categories));
}
        function updateCategory(index, newName) {
            let categories = JSON.parse(localStorage.getItem('categories')) || [];
            categories[index].name = newName.length > 15 ? newName.slice(0,15) : newName;
            localStorage.setItem('categories', JSON.stringify(categories));
        }

        function deleteCategory(index) {
    let categories = JSON.parse(localStorage.getItem('categories')) || [];
    
    if (index < 0 || index >= categories.length) {
        console.warn("–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏");
        return;
    }

    const categoryName = categories[index].name;

    // –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    const modal = document.createElement('div');
    modal.className = 'confirm-delete-modal';

    modal.innerHTML = `
        <div class="modal-content">
            <h3>–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?</h3>
            <div class="category-name">${categoryName}</div>
            <div class="warning-text">
                –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å<br>
                (–≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏)
            </div>
            <div class="buttons">
                <button class="btn-delete">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                <button class="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    modal.querySelector('.btn-delete').addEventListener('click', () => {
        categories.splice(index, 1);
        localStorage.setItem('categories', JSON.stringify(categories));
        modal.remove();
        renderCategories();
        
        // –ù–µ–±–æ–ª—å—à–æ–π —Ñ–∏–¥–±–µ–∫
        setTimeout(() => {
            alert(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ¬´${categoryName}¬ª —É–¥–∞–ª–µ–Ω–∞`);
        }, 80);
    });

    modal.querySelector('.btn-cancel').addEventListener('click', () => {
        modal.remove();
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

        function addCategory(button) {
            const container = document.getElementById('newCategoryContainer');
            if (!container) {
                console.warn('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä newCategoryContainer –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            container.innerHTML = '';
            const form = document.createElement('form');
            form.style.display = 'flex';
            form.style.gap = '10px';
            form.style.marginTop = '10px';
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
            input.id = 'newCategoryInput';
            input.required = true;
            input.style.flex = '1';
            input.style.padding = '8px';
            input.maxLength = 15;
            const saveBtn = document.createElement('button');
            saveBtn.type = 'submit';
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            saveBtn.style.padding = '8px 16px';
            saveBtn.onclick = (e) => {
                e.preventDefault();
                const categoryName = input.value.trim();
                if (categoryName) {
                    saveCategory(categoryName);
                    renderCategories();
                    container.innerHTML = '';
                } else {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                }
            };
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.textContent = '–û—Ç–º–µ–Ω–∞';
            cancelBtn.style.padding = '8px 16px';
            cancelBtn.style.backgroundColor = '#f0f0f0';
            cancelBtn.onclick = () => {
                container.innerHTML = '';
            };
            form.appendChild(input);
            form.appendChild(saveBtn);
            form.appendChild(cancelBtn);
            container.appendChild(form);
            input.focus();
        }

        function getFilteredHistory() {
            const history = JSON.parse(localStorage.getItem('expensesHistory')) || [];
            const filters = JSON.parse(localStorage.getItem('historyFilters')) || {};
            let filteredHistory = [...history];
            if (filters.year) {
                filteredHistory = filteredHistory.filter(exp => new Date(exp.dateISO).getFullYear() == filters.year);
            }
            if (filters.month) {
                filteredHistory = filteredHistory.filter(exp => new Date(exp.dateISO).getMonth() + 1 == filters.month);
            }
            if (filters.day) {
                filteredHistory = filteredHistory.filter(exp => new Date(exp.dateISO).getDate() == filters.day);
            }
            if (filters.bank) {
                filteredHistory = filteredHistory.filter(exp => exp.bank === filters.bank);
            }
            if (filters.category) {
                filteredHistory = filteredHistory.filter(exp => exp.category === filters.category);
            }
            const sortField = filters.sortField || 'dateISO';
            const sortOrder = filters.sortOrder || 'desc';
            filteredHistory.sort((a, b) => {
                let valueA, valueB;
                if (sortField === 'dateISO') {
                    valueA = new Date(a.dateISO);
                    valueB = new Date(b.dateISO);
                } else {
                    valueA = a[sortField].toLowerCase();
                    valueB = b[sortField].toLowerCase();
                }
                return sortOrder === 'asc' ? (valueA > valueB ? 1 : -1) : (valueA < valueB ? 1 : -1);
            });
            return filteredHistory;
        }

        function renderCategories() {
    const list = document.getElementById('categoriesList');
    const statsList = document.getElementById('statsCategories');
    const settingsList = document.getElementById('settingsCategories');
    list.innerHTML = '';
    if (statsList) statsList.innerHTML = '';
    if (settingsList) settingsList.innerHTML = '';
    let categories = JSON.parse(localStorage.getItem('categories')) || [];
    
    // –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º limitEnabled: false –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    categories = categories.map(cat => ({
        ...cat,
        limitEnabled: cat.limitEnabled ?? false
    }));
    localStorage.setItem('categories', JSON.stringify(categories));
            const filteredHistory = getFilteredHistory();
            const categorySums = {};
            categories.forEach(cat => {
                categorySums[cat.name] = { amount: 0, limit: cat.limit, limitEnabled: cat.limitEnabled };
            });
            filteredHistory.forEach(exp => {
                if (categorySums[exp.category]) {
                    categorySums[exp.category].amount += exp.amount;
                }
            });
            categories.forEach((cat, idx) => {
                const catBtn = document.createElement('button');
                let displayName = cat.name.length > 15 ? cat.name.slice(0,15) : cat.name;
                catBtn.textContent = displayName;
                let pressTimer;
                let isDragging = false;
                let startY, currentIndex = idx;
                catBtn.addEventListener('mousedown', startPress);
                catBtn.addEventListener('touchstart', startPress, { passive: false });
                catBtn.addEventListener('mouseup', cancelPress);
                catBtn.addEventListener('mouseleave', cancelPress);
                catBtn.addEventListener('touchend', cancelPress);

                function startPress(e) {
                    if (!dragEnabled) {
                        pressTimer = setTimeout(() => {
                            showActionModal(catBtn, currentIndex);
                        }, 1);
                        return;
                    }
                    if (e.type === 'touchstart') e.preventDefault();
                    startY = e.clientY || (e.touches && e.touches[0].clientY);
                    isDragging = false;
                    pressTimer = setTimeout(() => {
                        if (!isDragging) showActionModal(catBtn, currentIndex);
                    }, 10);

                    function onMove(ev) {
                        const moveY = ev.clientY || (ev.touches && ev.touches[0].clientY);
                        if (!isDragging && Math.abs(moveY - startY) > 5) {
                            isDragging = true;
                            clearTimeout(pressTimer);
                            removeActionModal();
                            catBtn.classList.add('dragging');
                        }
                        if (isDragging) {
                            const buttons = Array.from(list.children).filter(b => b.tagName === 'BUTTON');
                            let overIndex = buttons.findIndex(b => {
                                const rect = b.getBoundingClientRect();
                                return moveY > rect.top && moveY < rect.bottom;
                            });
                            if (overIndex !== -1 && overIndex !== currentIndex) {
                                list.insertBefore(catBtn, (overIndex > currentIndex ? buttons[overIndex].nextSibling : buttons[overIndex]));
                                let moved = categories.splice(currentIndex, 1)[0];
                                categories.splice(overIndex, 0, moved);
                                currentIndex = overIndex;
                                localStorage.setItem('categories', JSON.stringify(categories));
                            }
                        }
                    }

                    function endDrag() {
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('touchmove', onMove);
                        document.removeEventListener('mouseup', endDrag);
                        document.removeEventListener('touchend', endDrag);
                        catBtn.classList.remove('dragging');
                        clearTimeout(pressTimer);
                    }

                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('touchmove', onMove, { passive: false });
                    document.addEventListener('mouseup', endDrag);
                    document.addEventListener('touchend', endDrag);
                }

                function cancelPress() {
                    clearTimeout(pressTimer);
                }

                list.appendChild(catBtn);
                if (statsList) {
                    const statItem = document.createElement('div');
                    statItem.className = 'stat-item';
                    statItem.style.display = "flex";
                    statItem.style.justifyContent = "space-between";
                    statItem.style.alignItems = "center";
                    const left = document.createElement('span');
                    const amount = categorySums[cat.name]?.amount || 0;
                    left.textContent = `${cat.name}: ${amount.toFixed(2)} ‚ÇΩ`;
                    statItem.appendChild(left);
                    if (cat.limit && cat.limit > 0) {
                        const right = document.createElement('span');
                        let remaining = cat.limit - amount;
                        right.textContent = `–û—Å—Ç–∞—Ç–æ–∫: ${remaining.toFixed(2)} ‚ÇΩ`;
                        if (remaining < 0) {
                            right.style.color = "red";
                        }
                        statItem.appendChild(right);
                    }
                    statsList.appendChild(statItem);
                }
                if (settingsList) {
    const row = document.createElement('div');
    row.className = 'settings-row';
    const nameSpan = document.createElement('span');
    nameSpan.className = 'name';
    nameSpan.textContent = cat.name;
    row.appendChild(nameSpan);

    // Always create a limit badge, default to 0 if no limit is set
    const limitBadge = document.createElement('span');
    limitBadge.className = 'limit-badge';
    limitBadge.textContent = `${cat.limit || 0} ‚ÇΩ`; // Display 0 if cat.limit is undefined or 0
    if (cat.limitEnabled && cat.limit > 0) limitBadge.classList.add('active');
    row.appendChild(limitBadge);
    limitBadge.addEventListener('click', (e) => {
        e.stopPropagation();
        let touchTimer = setTimeout(() => {
            let categories = JSON.parse(localStorage.getItem('categories')) || [];
            let value = prompt(`–í–≤–µ–¥–∏—Ç–µ –ª–∏–º–∏—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${cat.name}"`, cat.limit || 0);
            if (value !== null && !isNaN(value)) {
                categories[idx].limit = parseFloat(value);
                localStorage.setItem('categories', JSON.stringify(categories));
                renderCategories();
            }
        }, 200);
        const cancelTouch = () => {
            clearTimeout(touchTimer);
            document.removeEventListener('mouseup', cancelTouch);
            document.removeEventListener('touchend', cancelTouch);
        };
        document.addEventListener('mouseup', cancelTouch);
        document.addEventListener('touchend', cancelTouch);
    });

    const label = document.createElement('label');
    label.className = 'switch';
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.checked = cat.limitEnabled ?? (cat.limit && cat.limit > 0);
    const slider = document.createElement('span');
    slider.className = 'slider';
    label.appendChild(input);
    label.appendChild(slider);
    row.appendChild(label);
    input.addEventListener('change', () => {
        let categories = JSON.parse(localStorage.getItem('categories')) || [];
        categories[idx].limitEnabled = input.checked;
        localStorage.setItem('categories', JSON.stringify(categories));
        const limitBadge = row.querySelector('.limit-badge');
        if (limitBadge) {
            if (input.checked && (cat.limit || 0) > 0) limitBadge.classList.add('active');
            else limitBadge.classList.remove('active');
        }
        calculateWeeklyExpenses();
    });
    settingsList.appendChild(row);
                }
            });

            renderChart(Object.keys(categorySums).map(name => ({
                name,
                amount: categorySums[name].amount,
                limit: categorySums[name].limit
            })));

            let total = Object.values(categorySums).reduce((sum, c) => sum + c.amount, 0);
            let totalLimits = Object.values(categorySums).reduce((sum, c) => sum + (c.limit || 0), 0);
            const totalContainer = document.getElementById('totalExpenses');
            if (totalContainer) {
                totalContainer.innerHTML = `<p>–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: ${total.toFixed(2)} ‚ÇΩ</p>
                <p id="weeklyExpenses">–Ω–µ–¥–µ–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã: 0 ‚ÇΩ</p>`;
            }
            const weeklyElem = document.getElementById('weeklyExpenses');
            if (weeklyElem) {
                let weeklyTotal = parseFloat(localStorage.getItem('weeklyTotal')) || 0;
                weeklyElem.textContent = `–Ω–µ–¥–µ–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã: ${weeklyTotal.toFixed(2)} ‚ÇΩ`;
            }
            const totalLimitsContainer = document.getElementById('totalLimits');
            if (totalLimitsContainer) {
                totalLimitsContainer.textContent = `–í—Å–µ–≥–æ –ª–∏–º–∏—Ç–æ–≤: ${totalLimits.toFixed(2)} ‚ÇΩ`;
            }
        }

        function renderChart(categories) {
            const ctx = document.getElementById('statsChart');
            if (!ctx) return;
            if (chartInstance) {
                chartInstance.destroy();
            }
            const labels = categories.map(c => c.name);
            const data = categories.map(c => c.amount);
            chartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FF6384','#36A2EB','#FFCE56',
                            '#4CAF50','#FF9800','#9C27B0',
                            '#00BCD4','#E91E63'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: {
                            display: true,
                            text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º'
                        }
                    }
                }
            });
        }

        let currentModal = null;
let outsideClickHandler = null;
let dragEnabled = false;
let hawkMode = false;

        function showActionModal(button, index) {
    if (hawkMode) return;

    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    removeActionModal();

    const modal = document.createElement('div');
    modal.className = 'action-modal';
    
    modal.innerHTML = `
        <button data-action="rename">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
        <button data-action="add-expense">–í–Ω–µ—Å—Ç–∏ —Ä–∞—Å—Ö–æ–¥</button>
        <button data-action="delete">–£–¥–∞–ª–∏—Ç—å</button>
        <button data-action="hawk" style="background: linear-gradient(135deg, #5A7DE1, #A0D4FA);">
            –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å ü¶Ö
        </button>
    `;

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï –ú–ï–°–¢–û ‚Äî –≤–æ—Ç —Å—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ–º
    document.body.appendChild(modal);

    // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–µ–≤–∏–¥–∏–º–æ –∏ —á—É—Ç—å –º–µ–Ω—å—à–µ)
    modal.style.position = 'fixed';
    modal.style.top = '50%';
    modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, -50%) scale(0.92)';
    modal.style.opacity = '0';
    modal.style.maxHeight = '85vh';
    modal.style.overflowY = 'auto';

    // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    modal.style.transition = 
        'opacity 0.18s ease, ' +
        'transform 0.28s cubic-bezier(0.34, 1.56, 0.64, 1)';

    // –ó–∞—Å—Ç–∞–≤–ª—è–µ–º –±—Ä–∞—É–∑–µ—Ä –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏
    void modal.offsetWidth;

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∫—Ä–∞—Å–∏–≤—É—é –∞–Ω–∏–º–∞—Ü–∏—é
    requestAnimationFrame(() => {
        modal.style.opacity = '1';
        modal.style.transform = 'translate(-50%, -50%) scale(1)';
    });
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –∫–æ–Ω–µ—Ü –≤–∞–∂–Ω–æ–≥–æ –±–ª–æ–∫–∞

    currentModal = modal;

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // –î–∞–ª—å—à–µ –∏–¥—ë—Ç –≤–∞—à —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–Ω–æ–ø–æ–∫ ‚Äî –µ–≥–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
    modal.querySelector('[data-action="rename"]').onclick = () => {
        removeActionModal();
        showRenameField(button, index);
    };

    modal.querySelector('[data-action="add-expense"]').onclick = () => {
    removeActionModal();

    const categoryName = button.textContent.trim(); // –∏–ª–∏ –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ categories[index].name

    const amount = prompt(`–í–Ω–µ—Å–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${categoryName}"\n\n–°–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏? (‚ÇΩ)`);

    if (!amount) return;                       // –æ—Ç–º–µ–Ω–∞
    if (!amount.trim()) return;
    
    const sum = parseFloat(amount.replace(',', '.'));
    if (isNaN(sum) || sum <= 0) {
        alert("–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ");
        return;
    }

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–∞—Å—Ö–æ–¥
    const now = new Date();
    const expense = {
        bank: localStorage.getItem('selectedBank') || "–î—Ä—É–≥–∏–µ",
        category: categoryName,
        amount: sum,
        dateISO: now.toISOString(),
        dateStr: now.toLocaleDateString('ru-RU'),
        dayOfWeek: now.toLocaleDateString('ru-RU', { weekday: 'long' })
    };

    let history = JSON.parse(localStorage.getItem('expensesHistory')) || [];
    history.push(expense);
    localStorage.setItem('expensesHistory', JSON.stringify(history));

    alert(`–†–∞—Å—Ö–æ–¥ ${sum} ‚ÇΩ –∑–∞–ø–∏—Å–∞–Ω –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${categoryName}" (${expense.bank})`);
    
    renderCategories();   // –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Å—É–º–º—ã
};

    modal.querySelector('[data-action="delete"]').onclick = () => {
        removeActionModal();
        deleteCategory(index);
    };

    modal.querySelector('[data-action="hawk"]').onclick = () => {
        removeActionModal();
        startHawkMode();
    };

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª–∫–∏
    const closeOnOutsideClick = (e) => {
        if (!modal.contains(e.target) && !button.contains(e.target)) {
            removeActionModal();
            document.removeEventListener('click', closeOnOutsideClick);
        }
    };

    setTimeout(() => {
        document.addEventListener('click', closeOnOutsideClick);
    }, 50);
}

        function removeActionModal() {
            if (currentModal) currentModal.remove();
            currentModal = null;
            if (outsideClickHandler) document.removeEventListener('click', outsideClickHandler);
            outsideClickHandler = null;
        }

        function showHistory() {
            let startX, startY;
            let scrollDirection = null;
            const history = JSON.parse(localStorage.getItem('expensesHistory')) || [];
            const filters = JSON.parse(localStorage.getItem('historyFilters')) || {};
            overlay.style.display = 'block';
            const modal = document.createElement('div');
            modal.className = 'history-modal';
            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-btn';
            closeBtn.onclick = () => {
                overlay.style.display = 'none';
                modal.remove();
                renderCategories();
            };
            const filterDiv = document.createElement('div');
            filterDiv.className = 'history-filter';
            const yearSelect = document.createElement('select');
            yearSelect.id = 'yearFilter';
            const monthSelect = document.createElement('select');
            monthSelect.id = 'monthFilter';
            const daySelect = document.createElement('select');
            daySelect.id = 'dayFilter';
            const bankSelect = document.createElement('select');
            bankSelect.id = 'bankFilter';
            const categorySelect = document.createElement('select');
            categorySelect.id = 'categoryFilter';
            const resetButton = document.createElement('button');
            resetButton.textContent = '–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã';
            resetButton.style.padding = '8px 16px';
            resetButton.style.background = 'linear-gradient(135deg, #f44336, #ff9999)';
            resetButton.style.color = 'white';
            resetButton.style.border = 'none';
            resetButton.style.borderRadius = '5px';
            resetButton.style.cursor = 'pointer';
            const years = [...new Set(history.map(exp => new Date(exp.dateISO).getFullYear()))].sort((a, b) => a - b);
            yearSelect.innerHTML = '<option value="">–í—Å–µ –≥–æ–¥—ã</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
            yearSelect.value = filters.year || '';
            const months = [
                { value: 1, text: '–Ø–Ω–≤–∞—Ä—å' }, { value: 2, text: '–§–µ–≤—Ä–∞–ª—å' }, { value: 3, text: '–ú–∞—Ä—Ç' },
                { value: 4, text: '–ê–ø—Ä–µ–ª—å' }, { value: 5, text: '–ú–∞–π' }, { value: 6, text: '–ò—é–Ω—å' },
                { value: 7, text: '–ò—é–ª—å' }, { value: 8, text: '–ê–≤–≥—É—Å—Ç' }, { value: 9, text: '–°–µ–Ω—Ç—è–±—Ä—å' },
                { value: 10, text: '–û–∫—Ç—è–±—Ä—å' }, { value: 11, text: '–ù–æ—è–±—Ä—å' }, { value: 12, text: '–î–µ–∫–∞–±—Ä—å' }
            ];
            monthSelect.innerHTML = '<option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>' + months.map(m => `<option value="${m.value}">${m.text}</option>`).join('');
            monthSelect.value = filters.month || '';
            const days = [...new Set(history.map(exp => new Date(exp.dateISO).getDate()))].sort((a, b) => a - b);
            daySelect.innerHTML = '<option value="">–í—Å–µ –¥–Ω–∏</option>' + days.map(d => `<option value="${d}">${d.toString().padStart(2, '0')}</option>`).join('');
            daySelect.value = filters.day || '';
            const banks = [...new Set(history.map(exp => exp.bank))].sort();
            bankSelect.innerHTML = '<option value="">–í—Å–µ –±–∞–Ω–∫–∏</option>' + banks.map(b => `<option value="${b}">${b}</option>`).join('');
            bankSelect.value = filters.bank || '';
            const categories = [...new Set(history.map(exp => exp.category))].sort();
            categorySelect.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
            categorySelect.value = filters.category || '';
            filterDiv.appendChild(yearSelect);
            filterDiv.appendChild(monthSelect);
            filterDiv.appendChild(daySelect);
            filterDiv.appendChild(bankSelect);
            filterDiv.appendChild(categorySelect);
            filterDiv.appendChild(resetButton);
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const headerRow = document.createElement('tr');
            ['–ë–∞–Ω–∫', '–î–∞—Ç–∞', '–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏', '–°—É–º–º–∞', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            function renderHistory(filteredHistory) {
                tbody.innerHTML = '';
                filteredHistory.forEach(exp => {
                    const row = document.createElement('tr');
                    [exp.bank, exp.dateStr, exp.dayOfWeek, `${exp.amount.toFixed(2)} ‚ÇΩ`, exp.category].forEach(text => {
                        const td = document.createElement('td');
                        td.textContent = text;
                        row.appendChild(td);
                    });
                    tbody.appendChild(row);
                });
            }

            function filterAndSortHistory() {
                let filteredHistory = [...history];
                filters.year = yearSelect.value;
                filters.month = monthSelect.value;
                filters.day = daySelect.value;
                filters.bank = bankSelect.value;
                filters.category = categorySelect.value;
                if (filters.year) {
                    filteredHistory = filteredHistory.filter(exp => new Date(exp.dateISO).getFullYear() == filters.year);
                }
                if (filters.month) {
                    filteredHistory = filteredHistory.filter(exp => new Date(exp.dateISO).getMonth() + 1 == filters.month);
                }
                if (filters.day) {
                    filteredHistory = filteredHistory.filter(exp => new Date(exp.dateISO).getDate() == filters.day);
                }
                if (filters.bank) {
                    filteredHistory = filteredHistory.filter(exp => exp.bank === filters.bank);
                }
                if (filters.category) {
                    filteredHistory = filteredHistory.filter(exp => exp.category === filters.category);
                }
                filteredHistory.sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO));
                localStorage.setItem('historyFilters', JSON.stringify(filters));
                renderHistory(filteredHistory);
                renderCategories();
            }

            resetButton.addEventListener('click', () => {
                yearSelect.value = '';
                monthSelect.value = '';
                daySelect.value = '';
                bankSelect.value = '';
                categorySelect.value = '';
                localStorage.removeItem('historyFilters');
                filterAndSortHistory();
            });

            [yearSelect, monthSelect, daySelect, bankSelect, categorySelect].forEach(select => {
                select.addEventListener('change', filterAndSortHistory);
            });

            table.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                scrollDirection = null;
            }, { passive: true });

            table.addEventListener('touchmove', (e) => {
                if (!scrollDirection) {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - startX);
                    const deltaY = Math.abs(touch.clientY - startY);
                    if (deltaX > deltaY && deltaX > 5) {
                        scrollDirection = 'horizontal';
                        table.style.touchAction = 'pan-x';
                    } else if (deltaY > deltaX && deltaY > 5) {
                        scrollDirection = 'vertical';
                        table.style.touchAction = 'pan-y';
                    }
                }
            }, { passive: true });

            table.addEventListener('touchend', () => {
                table.style.touchAction = 'auto';
                scrollDirection = null;
            });

            modal.appendChild(closeBtn);
            modal.appendChild(filterDiv);
            modal.appendChild(table);
            table.appendChild(thead);
            table.appendChild(tbody);
            document.body.appendChild(modal);
            filterAndSortHistory();
            const overlayHandler = () => {
                overlay.style.display = 'none';
                modal.remove();
                overlay.removeEventListener('click', overlayHandler);
                renderCategories();
            };
            overlay.addEventListener('click', overlayHandler);
        }

        function cleanOldExpenses() {
            const history = JSON.parse(localStorage.getItem('expensesHistory')) || [];
            const twelveMonthsAgo = new Date();
            twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);
            const recent = history.filter(exp => new Date(exp.dateISO) >= twelveMonthsAgo);
            localStorage.setItem('expensesHistory', JSON.stringify(recent));
        }

        function showRenameField(button, index) {
            const existing = button.parentNode.querySelector('.rename-container');
            if (existing) existing.remove();
            const container = document.createElement('div');
            container.className = 'rename-container';
            const input = document.createElement('input');
            const currentName = JSON.parse(localStorage.getItem('categories'))[index].name;
            input.type = 'text';
            input.value = currentName.length > 15 ? currentName.slice(0,15) : currentName;
            input.maxLength = 15;
            const saveBtn = document.createElement('button');
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            saveBtn.onclick = () => {
                let newName = input.value.trim();
                if (newName.length > 15) newName = newName.slice(0,15);
                if (newName) {
                    updateCategory(index, newName);
                    renderCategories();
                }
            };
            container.appendChild(input);
            container.appendChild(saveBtn);
            button.parentNode.insertBefore(container, button.nextSibling);
        }

        function getStartOfWeek() {
            const now = new Date();
            const day = now.getDay();
            const diff = now.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(now.setDate(diff));
            monday.setHours(0,0,0,0);
            return monday;
        }

        function calculateWeeklyExpenses() {
    const filteredHistory = getFilteredHistory();
    const startOfWeek = getStartOfWeek();
    const categories = JSON.parse(localStorage.getItem('categories')) || [];
    let weeklyTotal = 0;

    filteredHistory.forEach(exp => {
        const updateDate = new Date(exp.dateISO);
        const category = categories.find(cat => cat.name === exp.category);
        // –£—á–∏—Ç—ã–≤–∞–µ–º —Ç—Ä–∞—Ç—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ limitEnabled –≤–∫–ª—é—á–µ–Ω
        if (updateDate >= startOfWeek && category && category.limitEnabled) {
            weeklyTotal += exp.amount;
        }
    });

    localStorage.setItem('weeklyTotal', weeklyTotal.toString());
    const weeklyElem = document.getElementById('weeklyExpenses');
    if (weeklyElem) {
        weeklyElem.textContent = `–Ω–µ–¥–µ–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã: ${weeklyTotal.toFixed(2)} ‚ÇΩ`;
    }
}

        document.addEventListener('DOMContentLoaded', () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => console.log('SW registered: ', registration))
                    .catch(error => console.log('SW registration failed: ', error));
            }
            if (!localStorage.getItem('weeklyTotal')) {
                localStorage.setItem('weeklyTotal', '0');
            }
            cleanOldExpenses();
            autoResetMonthlyExpenses();
            autoResetWeeklyExpenses();
            initCards();
            showSection('expenses');
            renderCategories();
        });

        const canvas = document.getElementById('sparkCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        window.addEventListener('scroll', () => {
            const scrollTop = window.scrollY || document.documentElement.scrollTop;
            const docHeight = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight) - window.innerHeight;
            const scrollPercent = docHeight > 0 ? scrollTop / docHeight : 0;
            const maxHeight = window.innerHeight * 0.4;
            const scrollBar = document.getElementById('scrollBar');
            if(scrollBar) {
                scrollBar.style.top = '0';
                scrollBar.style.height = `${scrollPercent * maxHeight}px`;
            }
        });

        let particles = [];
        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 2 + 2;
                this.speedX = (Math.random() - 0.5) * 2;
                this.speedY = Math.random() * -2 - 1;
                this.alpha = 1;
                const hue = Math.random() * 30 + 20;
                this.color = `hsl(${hue}, 100%, 50%)`;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.alpha -= 0.02;
                this.size *= 0.95;
            }
            draw() {
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.ellipse(this.x, this.y, this.size, this.size * 0.3, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        const header = document.querySelector('header');
        header.addEventListener('pointermove', e => {
            for (let i = 0; i < 3; i++) particles.push(new Particle(e.clientX, e.clientY));
        });

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => {
                p.update();
                p.draw();
                if (p.alpha <= 0) particles.splice(i, 1);
            });
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        function toggleSubmenu() {
            const submenu = document.getElementById('settingsSubmenu');
            const adminSubmenu = document.getElementById('adminSubmenu');
            if (submenu.style.display === 'block') {
                submenu.style.display = 'none';
            } else {
                submenu.style.display = 'block';
                if (adminSubmenu) adminSubmenu.style.display = 'none';
            }
        }

        function toggleAdminSubmenu() {
            const adminSubmenu = document.getElementById('adminSubmenu');
            const submenu = document.getElementById('settingsSubmenu');
            if (adminSubmenu.style.display === 'block') {
                adminSubmenu.style.display = 'none';
            } else {
                adminSubmenu.style.display = 'block';
                if (submenu) submenu.style.display = 'none';
            }
        }

        function clearLimits() {
            let categories = JSON.parse(localStorage.getItem('categories')) || [];
            categories.forEach(c => c.limit = 0);
            localStorage.setItem('categories', JSON.stringify(categories));
            alert("–í—Å–µ –ª–∏–º–∏—Ç—ã —É–¥–∞–ª–µ–Ω—ã");
            renderCategories();
        }

        function clearExpenses() {
            let categories = JSON.parse(localStorage.getItem('categories')) || [];
            categories.forEach(c => c.amount = 0);
            localStorage.setItem('categories', JSON.stringify(categories));
            localStorage.setItem('expensesHistory', JSON.stringify([]));
            alert("–í—Å–µ —Ä–∞—Å—Ö–æ–¥—ã —É–¥–∞–ª–µ–Ω—ã");
            renderCategories();
        }

        function updateClock() {
            const now = new Date();
            const days = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
            const weekday = days[now.getDay()];
            const dateStr = now.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('clock').textContent = `${weekday}, ${dateStr} ${timeStr}`;
        }

        setInterval(updateClock, 1000);
        updateClock();

        function autoResetMonthlyExpenses() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const lastReset = JSON.parse(localStorage.getItem('lastResetMonth'));
            if (today.getDate() === 1 && (!lastReset || lastReset.month !== currentMonth || lastReset.year !== currentYear)) {
                let categories = JSON.parse(localStorage.getItem('categories')) || [];
                categories.forEach(c => c.amount = 0);
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('lastResetMonth', JSON.stringify({month: currentMonth, year: currentYear}));
                alert("–ù–æ–≤—ã–π –º–µ—Å—è—Ü! –í—Å–µ —Ä–∞—Å—Ö–æ–¥—ã –æ–±–Ω—É–ª–µ–Ω—ã.");
                renderCategories();
            }
        }

        function autoResetWeeklyExpenses() {
            const today = new Date();
            const day = today.getDay();
            if (day === 1) {
                const mondayDateStr = today.toISOString().slice(0,10);
                const lastWeeklyReset = localStorage.getItem('lastWeeklyReset');
                if (lastWeeklyReset !== mondayDateStr) {
                    localStorage.setItem('weeklyTotal', '0');
                    localStorage.setItem('lastWeeklyReset', mondayDateStr);
                    calculateWeeklyExpenses();
                }
            }
        }

        window.addEventListener('scroll', () => {
            const scrollTop = window.scrollY;
            const docHeight = document.documentElement.scrollHeight - window.innerHeight;
            const scrollPercent = docHeight > 0 ? scrollTop / docHeight : 0;
            const maxHeight = 50;
            const scrollBar = document.getElementById('scrollBar');
            if(scrollBar) scrollBar.style.height = `${scrollPercent * maxHeight}px`;
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(reg => {
                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            alert('–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                        }
                    });
                });
            });
        }
        // === üöÄ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Service Worker ===
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('/service-worker.js');
      console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', reg.scope);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
      reg.update();

      // –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'NEW_VERSION_READY') {
          console.log('üí´ –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
          showUpdateBanner(reg);
        }
      });
    } catch (err) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SW:', err);
    }
  });
}

// === üé® –ö—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ ===
function showUpdateBanner(reg) {
  const banner = document.createElement('div');
  banner.textContent = 'üí´ –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç—å?';
  Object.assign(banner.style, {
    position: 'fixed',
    bottom: '20px',
    left: '50%',
    transform: 'translateX(-50%)',
    background: '#222',
    color: '#fff',
    padding: '12px 20px',
    borderRadius: '8px',
    boxShadow: '0 2px 8px rgba(0,0,0,0.3)',
    zIndex: '9999',
    cursor: 'pointer',
    fontFamily: 'sans-serif',
    fontSize: '15px',
  });

  banner.addEventListener('click', () => {
    banner.textContent = 'üîÑ –û–±–Ω–æ–≤–ª—è–µ–º...';
    reg.waiting?.postMessage({ type: 'SKIP_WAITING' });
    setTimeout(() => window.location.reload(), 1000);
  });

  document.body.appendChild(banner);
}
function forceUpdate() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            for (let registration of registrations) {
                registration.unregister().then(() => {
                    console.log('Service Worker —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
                });
            }
            caches.keys().then(cacheNames => {
                return Promise.all(
                    cacheNames.map(cacheName => {
                        return caches.delete(cacheName).then(() => {
                            console.log(`–ö—ç—à ${cacheName} —É–¥–∞–ª–µ–Ω`);
                        });
                    })
                );
            }).then(() => {
                window.location.reload(true);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞:', err);
                window.location.reload(true);
            });
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π Service Worker:', err);
            window.location.reload(true);
        });
    } else {
        window.location.reload(true);
    }
    alert('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...');
}
function loadAppVersion() {
    fetch('/sw.js')
        .then(response => response.text())
        .then(text => {
            const versionMatch = text.match(/const CACHE_NAME = 'den-g-a-(v\d+)'/);
            const versionElement = document.getElementById('appVersion');
            if (versionMatch && versionMatch[1]) {
                versionElement.textContent = versionMatch[1]; // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä, "v12"
            } else {
                versionElement.textContent = 'v1.0.0'; // –í–µ—Ä—Å–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ service-worker.js:', error);
            document.getElementById('appVersion').textContent = 'v1.0.0'; // –í–µ—Ä—Å–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        });
}

// –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', loadAppVersion);

function startHawkMode() {
    hawkMode = true;
    dragEnabled = true;

    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
    document.body.style.cursor = 'move';
    alert('ü¶Ö –†–ï–ñ–ò–ú –Ø–°–¢–†–ï–ë–ê –í–ö–õ–Æ–ß–Å–ù!\n\n‚Ä¢ –ó–∞–∂–º–∏—Ç–µ –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n‚Ä¢ –î–ª—è –≤—ã—Ö–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ –±–æ–ª—å—à—É—é –∑–µ–ª—ë–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞');

    // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π
    let blocker = document.getElementById('hawkBlocker');
    if (!blocker) {
        blocker = document.createElement('div');
        blocker.id = 'hawkBlocker';
        blocker.style.cssText = `
            position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            z-index: 9998; pointer-events: none;
        `;
        document.body.appendChild(blocker);
    }

    // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
    let exitBtn = document.getElementById('exitHawkBtn');
    if (!exitBtn) {
        exitBtn = document.createElement('button');
        exitBtn.id = 'exitHawkBtn';
        exitBtn.textContent = '–ó–ê–í–ï–†–®–ò–¢–¨ –†–ï–ñ–ò–ú';
        exitBtn.style.cssText = `
            position: fixed; bottom: 30px; right: 30px;
            padding: 16px 32px; font-size: 18px; font-weight: bold;
            background: #4CAF50; color: white; border: none;
            border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            z-index: 100000; cursor: pointer;
        `;
        document.body.appendChild(exitBtn);
    }

    exitBtn.onclick = endHawkMode;
}

function endHawkMode() {
    hawkMode = false;
    dragEnabled = false;
    document.body.style.cursor = 'default';

    document.getElementById('hawkBlocker')?.remove();
    document.getElementById('exitHawkBtn')?.remove();

    alert('ü¶Ö –†–µ–∂–∏–º –Ø—Å—Ç—Ä–µ–±–∞ –≤—ã–∫–ª—é—á–µ–Ω');
}
    </script>
</div>
</body>
</html>
